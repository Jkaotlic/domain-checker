# Улучшение логики выдачи поддоменов — предложения

Ниже — приоритетный список практических улучшений, простым языком, полученный от субагента.

1. Расширить пассивные источники (crt.sh, SecurityTrails, CommonCrawl)
- Описание: подключить дополнительные пассивные API и парсеры CommonCrawl для поиска доменов.
- Почему: больше источников = меньше пропусков.
- Оценка: medium
- Реализация: добавить `lib/passiveSources.ts` и функции `getFromSecurityTrails`, `getFromCommonCrawl`.

2. Комбинированный обратный поиск (PTR + crt.sh + passive DNS)
- Описание: объединить PTR, crt.sh и passive DNS в один pipeline с дедупом.
- Почему: каждое API дополняет другие.
- Оценка: small
- Реализация: правки в `lib/reverse.ts`, кешировать по IP в `lib/cache.ts`.

3. Попытки zone transfer и авторитетные NS (AXFR)
- Описание: пробовать AXFR у авторитетных NS с таймаутом и безопасной обработкой.
- Почему: при открытом AXFR можно получить полный список поддоменов.
- Оценка: large
- Реализация: новая функция `tryZoneTransfer` в `lib/reverse.ts` или `lib/zone.ts`.

4. Генерация пермутаций и label-expansion
- Описание: генерировать частые префиксы/суффиксы (`-dev`, `-api`, `api1..5`) и проверять их.
- Почему: многие поддомены образуются по шаблонам.
- Оценка: medium
- Реализация: генератор в `lib/subdomain.ts`, вызывать из `app/api/check/route.ts` с лимитом.

5. Детекция wildcard и фильтрация ложных срабатываний
- Описание: проверять наличие wildcard A/CNAME и помечать такие результаты `wildcard`.
- Почему: уменьшит false positives.
- Оценка: small
- Реализация: добавить проверку в `lib/reverse.ts`, сохранять тег в структуре `lib/types.ts`.

6. Фоновые enrichment jobs (асинхронное обогащение)
- Описание: очередь/фоновые задания для позднего сбора PTR, crt.sh, TLS info.
- Почему: быстрый ответ API + улучшение данных в фоне.
- Оценка: medium
- Реализация: новый `lib/enricher.ts`, хранить прогресс в кэше/Redis.

7. Улучшить кэширование и TTL по источникам
- Описание: разные TTL для live DNS, crt.sh, passive DNS; использовать Redis при `REDIS_URL`.
- Почему: меньше внешних запросов и более корректные обновления.
- Оценка: small
- Реализация: расширить `lib/cache.ts` и `lib/redisAdapter.ts` с поддержкой TTL.

8. Сложный дедуп/слияние и расширенный скоринг
- Описание: учитывать наличие TLS CN, возраст записи, число уникальных IP при скоринге.
- Почему: приоритизация качественных и релевантных поддоменов.
- Оценка: medium
- Реализация: правки в `lib/aggregator.ts` и `lib/score.ts`.

9. Rate-limit и backoff для внешних API
- Описание: limiter с экспоненциальным бэкоффом для всех внешних вызовов.
- Почему: предотвращает блокировки и ошибки.
- Оценка: small
- Реализация: использовать `p-limit` или собственный limiter в `lib/reverse.ts`.

10. Фильтрация приватных/локальных адресов и TLD-несовпадений
- Описание: отбрасывать RFC1918, loopback, link-local и хосты, не заканчивающиеся на целевой домен.
- Почему: уменьшит нерелевантные результаты.
- Оценка: small
- Реализация: проверить в `lib/aggregator.ts` перед вставкой.

11. Пакетная проверка DNS (A, AAAA, CNAME) и сбор метаданных
- Описание: параллельно резолвить A/AAAA/CNAME и TTL для полного набора адресов.
- Почему: видна инфраструктура (IPv6, CNAME-цепочки).
- Оценка: small
- Реализация: расширить `lib/reverse.ts` и структуру `lib/types.ts`.

12. Privacy-first режим (no-active-scan)
- Описание: флаг `respectPrivacy` для отключения active probing и внешних enrichment.
- Почему: юридическая и этическая безопасность.
- Оценка: small
- Реализация: параметр в API (`app/api/check/route.ts`) и условные ветки в `lib/enricher.ts`.

---

Три теста, которые стоит добавить:
- `__tests__/reverse.extractDomains.test.ts` — проверяет, что `extractDomainsFromText` корректно извлекает и нормализует домены.
- `__tests__/check.commonSubdomains.test.ts` — интеграционный тест генератора пермутаций с моками DNS и проверкой фильтрации wildcard.
- `__tests__/aggregator.merge.test.ts` — юнит-тест `mergeSubdomainEntries`, проверяющий корректное объединение IP, тегов и источников.

Файл с этими предложениями создан: `SUBDOMAIN_IMPROVEMENTS.md`.
